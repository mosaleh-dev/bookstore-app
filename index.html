<!doctype html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bookstore CRUD</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Oxygen,
          Ubuntu,
          Cantarell,
          "Open Sans",
          "Helvetica Neue",
          sans-serif;
        margin: 20px;
        background-color: #f4f4f9;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      form {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="number"],
      input[type="file"],
      input[type="password"],
      button {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      input[type="file"] {
        padding: 3px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s ease-in-out;
      }
      button:hover {
        background-color: #0056b3;
      }
      #cancelEditButton {
        background-color: #6c757d;
      }
      #cancelEditButton:hover {
        background-color: #545b62;
      }
      .delete-btn {
        background-color: #dc3545;
      }
      .delete-btn:hover {
        background-color: #c82333;
      }
      #bookList ul {
        list-style-type: none;
        padding: 0;
      }
      #bookList li {
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
      }
      #bookList img {
        max-width: 60px;
        max-height: 80px;
        margin-right: 15px;
        border: 1px solid #eee;
        object-fit: cover;
      }
      .message {
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-size: 0.95em;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .book-details {
        flex-grow: 1;
        min-width: 200px;
      }
      .book-actions button {
        font-size: 0.9em;
        padding: 6px 12px;
        margin-left: 5px;
        width: auto;
      }
      .auth-forms {
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }
      .auth-forms form {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Bookstore Management</h1>
      <div id="messageArea"></div>

      <div class="auth-forms">
        <form id="registerForm">
          <h2>Register</h2>
          <div>
            <label for="regUsername">Username:</label>
            <input type="text" id="regUsername" name="username" required />
          </div>
          <div>
            <label for="regPassword">Password:</label>
            <input type="password" id="regPassword" name="password" required />
          </div>
          <button type="submit">Register</button>
        </form>

        <form id="loginForm">
          <h2>Login</h2>
          <div>
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" name="username" required />
          </div>
          <div>
            <label for="loginPassword">Password:</label>
            <input
              type="password"
              id="loginPassword"
              name="password"
              required
            />
          </div>
          <button type="submit">Login</button>
        </form>
      </div>
      <button
        id="logoutButton"
        style="
          display: none;
          margin-top: 10px;
          background-color: #ffc107;
          color: black;
        "
      >
        Logout
      </button>

      <form id="bookForm" enctype="multipart/form-data">
        <h2>Add / Edit Book</h2>
        <input type="hidden" id="bookId" name="bookId" />
        <div>
          <label for="title">Title:</label>
          <input type="text" id="title" name="title" required />
        </div>
        <div>
          <label for="author">Author:</label>
          <input type="text" id="author" name="author" required />
        </div>
        <div>
          <label for="year">Year (Optional):</label>
          <input type="number" id="year" name="year" placeholder="e.g., 1990" />
        </div>
        <!-- <div> -->
        <!--   <label for="coverImage">Cover Image (Optional):</label> -->
        <!--   <input -->
        <!--     type="file" -->
        <!--     id="coverImage" -->
        <!--     name="coverImage" -->
        <!--     accept="image/png, image/jpeg, image/gif" -->
        <!--   /> -->
        <!--   <small -->
        <!--     id="currentImageText" -->
        <!--     style="display: block; margin-top: 5px" -->
        <!--   ></small> -->
        <!-- </div> -->
        <button type="submit" id="submitButton">Add Book</button>
        <button type="button" id="cancelEditButton" style="display: none">
          Cancel Edit
        </button>
      </form>

      <div id="bookList">
        <h2>Book List</h2>
        <p>Loading books...</p>
        <ul></ul>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_BASE_URL = "http://localhost:3000";
        const authApiUrl = `${API_BASE_URL}/auth`;
        const booksApiUrl = `${API_BASE_URL}/books`;

        const registerForm = document.getElementById("registerForm");
        const loginForm = document.getElementById("loginForm");
        const logoutButton = document.getElementById("logoutButton");

        const bookForm = document.getElementById("bookForm");
        const bookIdInput = document.getElementById("bookId");
        const titleInput = document.getElementById("title");
        const authorInput = document.getElementById("author");
        const yearInput = document.getElementById("year");
        const coverImageInput = document.getElementById("coverImage");
        const currentImageText = document.getElementById("currentImageText");
        const submitButton = document.getElementById("submitButton");
        const cancelEditButton = document.getElementById("cancelEditButton");
        const bookListUl = document.querySelector("#bookList ul");
        const messageArea = document.getElementById("messageArea");

        var authToken = localStorage.getItem("authToken");

        function showMessage(message, type = "success") {
          messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
          setTimeout(() => {
            messageArea.innerHTML = "";
          }, 4000);
        }

        function updateLoginState() {
          if (authToken) {
            loginForm.style.display = "none";
            registerForm.style.display = "none";
            logoutButton.style.display = "block";
            bookForm.style.display = "block";
            document.getElementById("bookList").style.display = "block";
            fetchBooks();
          } else {
            loginForm.style.display = "block";
            registerForm.style.display = "block";
            logoutButton.style.display = "none";
            bookForm.style.display = "none";
            document.getElementById("bookList").style.display = "none";
          }
        }

        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(registerForm);
          const data = Object.fromEntries(formData.entries());
          try {
            const response = await fetch(`${authApiUrl}/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (!response.ok)
              throw new Error(
                result.error ||
                  JSON.stringify(result.errors) ||
                  "Registration failed",
              );
            showMessage("Registration successful! Please log in.", "success");
            registerForm.reset();
          } catch (error) {
            showMessage(error.message, "error");
          }
        });

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(loginForm);
          const data = Object.fromEntries(formData.entries());
          try {
            const response = await fetch(`${authApiUrl}/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (!response.ok)
              throw new Error(
                result.error || JSON.stringify(result.errors) || "Login failed",
              );
            authToken = result.token;
            localStorage.setItem("authToken", authToken);
            showMessage("Login successful!", "success");
            loginForm.reset();
            updateLoginState();
          } catch (error) {
            showMessage(error.message, "error");
          }
        });

        logoutButton.addEventListener("click", () => {
          authToken = null;
          localStorage.removeItem("authToken");
          showMessage("Logged out successfully.", "success");
          updateLoginState();
        });

        function renderBooks(books) {
          bookListUl.innerHTML = "";
          if (books.length === 0) {
            bookListUl.innerHTML =
              "<li>No books found. Add one using the form above!</li>";
            return;
          }
          books.forEach((book) => {
            const li = document.createElement("li");
            let coverImageHtml = book.coverImage
              ? `<img src="${API_BASE_URL}/${book.coverImage}" alt="${book.title} cover">`
              : `<div style="width:60px; height:80px; background:#eee; margin-right:15px; text-align:center; line-height:80px; font-size:0.8em; color:#aaa;">No Image</div>`;

            li.innerHTML = `
            ${coverImageHtml}
            <div class="book-details">
              <strong>${book.title}</strong><br>
              Author: ${book.author || "N/A"}<br>
              ${book.year ? `Year: ${book.year}` : ""}<br>
              <small>Owner: ${book.createdBy?.username || "Unknown"}</small>
            </div>
            <div class="book-actions">
              <button class="edit-btn" data-id="${book._id}">Edit</button>
              <button class="delete-btn" data-id="${book._id}">Delete</button>
            </div>
          `;
            bookListUl.appendChild(li);
          });
        }

        async function fetchBooks() {
          if (!authToken) {
            bookListUl.innerHTML = "<li>Please log in to see books.</li>";
            return;
          }
          try {
            bookListUl.innerHTML = "<li>Loading books...</li>";
            const response = await fetch(booksApiUrl, {
              headers: { Authorization: `Bearer ${authToken}` },
            });
            if (response.status === 401) {
              authToken = null;
              localStorage.removeItem("authToken");
              updateLoginState();
              showMessage("Session expired. Please log in again.", "error");
              return;
            }
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            const books = await response.json();
            renderBooks(books);
          } catch (error) {
            showMessage("Failed to load books. " + error.message, "error");
            bookListUl.innerHTML =
              "<li>Error loading books. Check console and ensure API is running and you are logged in.</li>";
          }
        }

        function resetForm() {
          bookForm.reset();
          bookIdInput.value = "";
          currentImageText.textContent = "";
          coverImageInput.value = "";
          submitButton.textContent = "Add Book";
          cancelEditButton.style.display = "none";
          titleInput.focus();
        }

        bookForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!authToken) {
            showMessage(
              "You must be logged in to perform this action.",
              "error",
            );
            return;
          }
          const formData = new FormData(bookForm);
          if (!formData.get("year")) formData.delete("year");

          const currentBookId = bookIdInput.value;

          const url = currentBookId
            ? `${booksApiUrl}/${currentBookId}`
            : booksApiUrl;
          const method = currentBookId ? "PUT" : "POST";

          try {
            const response = await fetch(url, {
              method,
              headers: { Authorization: `Bearer ${authToken}` },
              body: formData,
            });
            const responseBody = await response.json();

            if (response.status === 401) {
              authToken = null;
              localStorage.removeItem("authToken");
              updateLoginState();
              showMessage(
                "Session expired or unauthorized. Please log in again.",
                "error",
              );
              return;
            }
            if (!response.ok)
              throw new Error(
                responseBody.error ||
                  JSON.stringify(responseBody.errors) ||
                  `Operation failed with status: ${response.status}`,
              );
            showMessage(
              `Book ${currentBookId ? "updated" : "created"} successfully!`,
            );
            resetForm();
            fetchBooks();
          } catch (error) {
            showMessage(
              error.message ||
                `Failed to ${currentBookId ? "update" : "create"} book.`,
              "error",
            );
          }
        });

        async function populateEditForm(bookId) {
          if (!authToken) {
            showMessage(
              "You must be logged in to perform this action.",
              "error",
            );
            return;
          }
          try {
            const response = await fetch(`${booksApiUrl}/${bookId}`, {
              headers: { Authorization: `Bearer ${authToken}` },
            });
            if (response.status === 401) {
              authToken = null;
              localStorage.removeItem("authToken");
              updateLoginState();
              showMessage(
                "Session expired or unauthorized. Please log in again.",
                "error",
              );
              return;
            }
            if (!response.ok)
              throw new Error("Failed to fetch book details for editing.");
            const book = await response.json();

            bookIdInput.value = book._id;
            titleInput.value = book.title;
            authorInput.value = book.author;
            yearInput.value = book.year || "";
            coverImageInput.value = "";

            currentImageText.textContent = book.coverImage
              ? `Current image: ${book.coverImage.split("/").pop()}. Select a new file to change it.`
              : "No current image. Select a file to add one.";

            submitButton.textContent = "Update Book";
            cancelEditButton.style.display = "inline-block";
            window.scrollTo({
              top: bookForm.offsetTop - 20,
              behavior: "smooth",
            });
            titleInput.focus();
          } catch (error) {
            showMessage(error.message, "error");
          }
        }

        async function deleteBook(bookId) {
          if (!authToken) {
            showMessage(
              "You must be logged in to perform this action.",
              "error",
            );
            return;
          }
          if (
            !confirm(
              "Are you sure you want to delete this book? This action cannot be undone.",
            )
          )
            return;
          try {
            const response = await fetch(`${booksApiUrl}/${bookId}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${authToken}` },
            });
            const responseBody = await response.json();
            if (response.status === 401) {
              authToken = null;
              localStorage.removeItem("authToken");
              updateLoginState();
              showMessage(
                "Session expired or unauthorized. Please log in again.",
                "error",
              );
              return;
            }
            if (!response.ok)
              throw new Error(
                responseBody.error ||
                  JSON.stringify(responseBody.errors) ||
                  `Failed to delete book (status: ${response.status})`,
              );
            showMessage(responseBody.message || "Book deleted successfully!");
            fetchBooks();
          } catch (error) {
            showMessage(error.message || "Failed to delete book.", "error");
          }
        }

        bookListUl.addEventListener("click", (event) => {
          const targetButton = event.target.closest("button");
          if (!targetButton) return;

          const bookId = targetButton.dataset.id;
          if (targetButton.classList.contains("edit-btn")) {
            populateEditForm(bookId);
          } else if (targetButton.classList.contains("delete-btn")) {
            deleteBook(bookId);
          }
        });

        cancelEditButton.addEventListener("click", resetForm);

        updateLoginState();
      });

      document.addEventListener("DOMContentLoaded", () => {
        const bookForm = document.getElementById("bookForm");
        const bookList = document.getElementById("bookList");

        bookForm.style.display = "none";
        bookList.style.display = "none";

        updateLoginState();
      });
    </script>
  </body>
</html>
